name: AIgogo iOS Build

on:
  push:
    branches: [main]

concurrency:
  group: AIgogo-iOS-Build
  cancel-in-progress: true

jobs:
  build:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.2'

    - name: Install CocoaPods
      run: gem install cocoapods

    - name: Pod install
      run: |
        if [ ! -f Podfile ]; then
          cat > Podfile <<EOP
platform :ios, '15.0'
use_frameworks!

target 'AIgogo' do
  project 'Aigogo.xcodeproj'
end
EOP
        fi
        pod install --repo-update || true

    - name: Build unsigned IPA
      run: |
        mkdir -p build
        if [ -f Aigogo.xcworkspace ]; then
          xcodebuild \
            -workspace Aigogo.xcworkspace \
            -scheme AIgogo \
            -sdk iphoneos \
            -configuration Release \
            archive -archivePath ./build/AIgogo.xcarchive \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO CODE_SIGN_IDENTITY=""
        else
          xcodebuild \
            -project Aigogo.xcodeproj \
            -scheme AIgogo \
            -sdk iphoneos \
            -configuration Release \
            archive -archivePath ./build/AIgogo.xcarchive \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO CODE_SIGN_IDENTITY=""
        fi

        cat > exportOptions.plist <<EOP
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>method</key>
  <string>developer-id</string>
  <key>compileBitcode</key>
  <false/>
  <key>signingStyle</key>
  <string>manual</string>
</dict>
</plist>
EOP

        xcodebuild -exportArchive \
          -archivePath ./build/AIgogo.xcarchive \
          -exportOptionsPlist exportOptions.plist \
          -exportPath ./build \
          CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO CODE_SIGN_IDENTITY=""

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: AIgogo-unsigned
        path: ./build/AIgogo.ipa
